<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document PiP Example</title>
    <style>
        #screenshotButton {
            margin-top: 10px;
        }

        #page-background {
            position: relative;
        }

        #selection-box {
            position: absolute;
            border: 2px solid red;
            background-color: rgba(255, 0, 0, 0.2);
            pointer-events: none;
        }
    </style>
</head>

<body>
    <div id="page-background">
        <input type="button" onclick="startScreenshotMode();" value="PiP Screenshot" />
        <div id="selection-box"></div>
    </div>

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.js"></script>
    <script>
        let isSelecting = false;
        let startX, startY, endX, endY;

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof html2canvas === 'function') {
                console.log('html2canvas is loaded');
            } else {
                console.error('html2canvas is not loaded');
            }
        });

        function startScreenshotMode() {
            document.addEventListener('mousedown', handleMouseDown);
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        }

        function handleMouseDown(event) {
            isSelecting = true;
            startX = event.clientX;
            startY = event.clientY;
        }

        function handleMouseMove(event) {
            if (isSelecting) {
                endX = event.clientX;
                endY = event.clientY;

                updateSelectionBox();
            }
        }

        function handleMouseUp() {
            if (isSelecting) {
                isSelecting = false;

                // Capture the selected area as an image
                captureSelectedArea()
                    .then(selectedImage => {
                        // Display the image in a PiP window
                        showImageInPiP(selectedImage);
                    })
                    .catch(error => {
                        console.error('Error capturing the selected area:', error);
                    });

                // Clear the selection box
                clearSelectionBox();

                // Remove event listeners
                document.removeEventListener('mousedown', handleMouseDown);
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
            }
        }

        function updateSelectionBox() {
            const selectionBox = document.getElementById('selection-box');
            const width = Math.abs(endX - startX);
            const height = Math.abs(endY - startY);

            selectionBox.style.width = `${width}px`;
            selectionBox.style.height = `${height}px`;
            selectionBox.style.left = `${Math.min(startX, endX)}px`;
            selectionBox.style.top = `${Math.min(startY, endY)}px`;
        }

        function clearSelectionBox() {
            const selectionBox = document.getElementById('selection-box');
            selectionBox.style.width = '0';
            selectionBox.style.height = '0';

            // Reset cursor position
            startX = 0;
            startY = 0;
            endX = 0;
            endY = 0;
        }

        function captureSelectedArea() {
            return new Promise((resolve, reject) => {
                html2canvas(document.documentElement, {
                    windowWidth: Math.abs(endX - startX),
                    windowHeight: Math.abs(endY - startY),
                    x: Math.min(startX, endX),
                    y: Math.min(startY, endY),
                })
                    .then(canvas => {
                        resolve(canvas.toDataURL('image/png'));
                    })
                    .catch(error => {
                        reject(error);
                    });
            });
        }

        function showImageInPiP(imageDataURL) {
            const img = document.createElement('img');
            img.src = imageDataURL;

           // Wait for the image to load before obtaining its dimensions
            // Create PiP window with dimensions based on the image
            const pipOptions = {
                width: 300,
                height: 300,
            };

            documentPictureInPicture.requestWindow(pipOptions).then(pipWin => {
                img.classList.add('pip-mode');
                pipWin.document.body.append(img);
            });
        }
    </script>
</body>

</html>
